{"version":3,"file":"ONVIFMetadataTransport.js","sourceRoot":"","sources":["../../lib/transports/ONVIFMetadataTransport.ts"],"names":[],"mappings":";AAAA,wDAAwD;AACxD,uBAAuB;AACvB,mCAAmC;;AAOnC,2BAAuB;AASvB,MAAqB,sBAAsB;IAKzC,YAAY,MAAkB,EAAE,MAAgB,EAAE,OAAgB;QAChE,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,GAAG,GAAG,EAAE,CAAC;QAEd,MAAM,CAAC,EAAE,CAAC,MAAM,EAAE,CAAC,OAAO,EAAE,IAAI,EAAE,MAAM,EAAE,EAAE;YAC1C,IAAI,OAAO,IAAI,OAAO,CAAC,UAAU,EAAE;gBACjC,IAAI,CAAC,gBAAgB,CAAC,MAAM,CAAC,CAAC;aAC/B;QACH,CAAC,CAAC,CAAC;IACL,CAAC;IAED,gBAAgB,CAAC,MAAiB;QAChC,iCAAiC;QAEjC,qBAAqB;QACrB,IAAI,CAAC,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC,CAAC;QAEtD,IAAI,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE;YACtB,4BAA4B;YAC5B,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;YAC5B,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,QAAG,GAAC,QAAG,CAAC,CAAC;YAC3B,IAAI,CAAC,GAAG,GAAG,EAAE,CAAC;SACf;IACH,CAAC;CACF;AA9BD,yCA8BC","sourcesContent":["// De-packetize RTP packets to re-create ONVIF Mfetadata\r\n// Write data to a file\r\n// By Roger Hardiman, December 2021\r\n\r\nimport RTSPClient from \"../RTSPClient\";\r\nimport { RTPPacket } from \"../util\";\r\n\r\nimport * as transform from \"sdp-transform\";\r\nimport { Writable } from \"stream\";\r\nimport {EOL} from \"os\";\r\n\r\ninterface Details {\r\n  codec: string;\r\n  mediaSource: transform.MediaDescription;\r\n  rtpChannel: number;\r\n  rtcpChannel: number;\r\n}\r\n\r\nexport default class ONVIFMetadataTransport {\r\n  client: RTSPClient;\r\n  stream: Writable;\r\n  xml: string;\r\n\r\n  constructor(client: RTSPClient, stream: Writable, details: Details) {\r\n    this.client = client;\r\n    this.stream = stream;\r\n    this.xml = \"\";\r\n\r\n    client.on(\"data\", (channel, data, packet) => {\r\n      if (channel == details.rtpChannel) {\r\n        this.processRTPPacket(packet);\r\n      }\r\n    });\r\n  }\r\n\r\n  processRTPPacket(packet: RTPPacket): void {\r\n    // RTP Payload for ONVIF Metadata\r\n\r\n    // Accumulate payload\r\n    this.xml = this.xml.concat(packet.payload.toString());\r\n\r\n    if (packet.marker == 1) {\r\n      // end of xml, write to file\r\n      this.stream.write(this.xml);\r\n      this.stream.write(EOL+EOL);\r\n      this.xml = \"\";\r\n    }\r\n  }\r\n}\r\n"]}