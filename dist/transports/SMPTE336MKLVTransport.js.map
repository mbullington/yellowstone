{"version":3,"file":"SMPTE336MKLVTransport.js","sourceRoot":"","sources":["../../lib/transports/SMPTE336MKLVTransport.ts"],"names":[],"mappings":";AAAA,6FAA6F;AAC7F,2CAA2C;AAC3C,8CAA8C;AAC9C,kCAAkC;;AAelC,MAAqB,qBAAqB;IAKxC,YAAY,MAAkB,EAAE,MAAgB,EAAE,OAAgB;QAChE,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,OAAO,GAAG,EAAE,CAAC;QAElB,MAAM,CAAC,EAAE,CAAC,MAAM,EAAE,CAAC,OAAO,EAAE,IAAI,EAAE,MAAM,EAAE,EAAE;YAC1C,IAAI,OAAO,IAAI,OAAO,CAAC,UAAU,EAAE;gBACjC,IAAI,CAAC,gBAAgB,CAAC,MAAM,CAAC,CAAC;aAC/B;QACH,CAAC,CAAC,CAAC;IACL,CAAC;IAED,gBAAgB,CAAC,MAAiB;QAChC,iCAAiC;QAEjC,qBAAqB;QACrB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,CAAA;QAEjC,IAAI,MAAM,CAAC,MAAM,IAAI,CAAC,EAAE,EAAG,0CAA0C;YACnE,8BAA8B;YAC9B,oEAAoE;YACpE,sGAAsG;YACtG,KAAI,MAAM,MAAM,IAAI,IAAI,CAAC,OAAO,EAAE;gBAChC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;aAC3B;YACD,IAAI,CAAC,OAAO,GAAG,EAAE,CAAC;SACnB;IACH,CAAC;CACF;AAjCD,wCAiCC","sourcesContent":["// De-packetize RC 6597 RTP packets to re-create SMPTE336M KLV Metadata including STANAG 4609\r\n// Write data to a file as raw binary data.\r\n// The RTP timestamp is not saved to the file.\r\n// By Roger Hardiman, January 2026\r\n\r\nimport RTSPClient from \"../RTSPClient\";\r\nimport { RTPPacket } from \"../util\";\r\n\r\nimport * as transform from \"sdp-transform\";\r\nimport { Writable } from \"stream\";\r\n\r\ninterface Details {\r\n  codec: string;\r\n  mediaSource: transform.MediaDescription;\r\n  rtpChannel: number;\r\n  rtcpChannel: number;\r\n}\r\n\r\nexport default class SMPTE336MKLVTransport {\r\n  client: RTSPClient;\r\n  stream: Writable;\r\n  rawData: Buffer[];\r\n\r\n  constructor(client: RTSPClient, stream: Writable, details: Details) {\r\n    this.client = client;\r\n    this.stream = stream;\r\n    this.rawData = [];\r\n\r\n    client.on(\"data\", (channel, data, packet) => {\r\n      if (channel == details.rtpChannel) {\r\n        this.processRTPPacket(packet);\r\n      }\r\n    });\r\n  }\r\n\r\n  processRTPPacket(packet: RTPPacket): void {\r\n    // RTP Payload for ONVIF Metadata\r\n\r\n    // Accumulate payload\r\n    this.rawData.push(packet.payload)\r\n\r\n    if (packet.marker == 1) {  // TODO... OR if the Timestamp has changed\r\n      // end of data. Write the file\r\n      // In this case we can just write each Buffer from the rawData array\r\n      // If we were passing the KLV to a caller, we would concatenate the Buffers in the rawData array first\r\n      for(const buffer of this.rawData) {\r\n        this.stream.write(buffer);\r\n      }\r\n      this.rawData = [];\r\n    }\r\n  }\r\n}\r\n"]}